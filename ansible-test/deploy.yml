---
    - hosts: localhost
      gather_facts: false
    
      vars_files:
        - vars/main.yml
    
      tasks:
        - name: Create nginx deployment
          k8s:
            src: ../ansible/kubernetes/nginx/deployment/deployment.yaml
            kubeconfig: '{{ k8s_kubeconfig }}'
            state: present
        
        - name: Sleep for 1 minute and continue with play
          wait_for:
            timeout: 60

        - name: Create loadbalancer service
          k8s:
            src: ../ansible/kubernetes/nginx/services/loadbalancer.yaml
            kubeconfig: '{{ k8s_kubeconfig }}'
            state: present
          register: nginx_svc

        - name: Sleep for 1 minute and continue with play
          wait_for:
            timeout: 60
        
        - name: Set the load balancer URL as a fact.
          set_fact:
            ngnix_lb_host: "{{ nginx_svc['result']['status']['loadBalancer']['ingress'][0]['hostname'] }}"
          when: aws_environment | bool
        
        - name: Wait for load balancer to respond.
          uri:
            url: "http://{{ ngnix_lb_host }}"
          register: lb_result
          until: lb_result.status == 200
          retries: 60
          delay: 5
          when: aws_environment | bool
        
        - name: Get ELB information
          ec2_elb_info:
            region: "{{ aws_region }}"
            profile: "{{ aws_profile }}"
            names: "{{ ngnix_lb_host.split('-')[0] }}"
          register: elb_info
          when: aws_environment | bool
